package de.d4ve.uni.seminar;

import java.io.IOException;
import java.net.DatagramPacket;
import java.net.DatagramSocket;
import java.net.Inet4Address;
import java.net.InetAddress;
import java.net.SocketException;
import java.net.UnknownHostException;
import java.nio.ByteBuffer;
import java.nio.channels.IllegalBlockingModeException;
import java.util.Arrays;
import java.util.zip.CRC32;

public class SocketServer {

    public static void main(String[] args) throws UnknownHostException {
        InetAddress target = Inet4Address.getByName("localhost");

        //Creating a new datagram socket for sending and reciving packets.
        DatagramSocket socket = null;
        try {
            socket = new DatagramSocket(8888);
        } catch (SocketException exception) {
            System.err.printf("ERROR > Datagram Socket initilization error: %s\n",
                    exception.getLocalizedMessage());
            throw new IllegalStateException("Programm in invalid state, socket cannot be initialized!");
        }

        byte[] data_packet = new byte[256];
        int length;

        while (true) {
            //Setting all array entries to zero.
            for (int i = 0; i < data_packet.length; i++) {
                data_packet[i] = 0;
            }

            try {
                length = System.in.read(data_packet, 0, 248);
            } catch (IOException e) {
                e.printStackTrace();
                length = 0;
            }

            CRC32 checksum = new CRC32();
            checksum.update(data_packet);
            Long v_checksum = checksum.getValue();

            byte[] checksum_array = longToBytes(v_checksum);

            System.arraycopy(checksum_array, 0, data_packet, 248, checksum_array.length);

            DatagramPacket packet = new DatagramPacket(data_packet, 0, length, target,8889);

            try {
                socket.send(packet);
                socket.receive(packet);
            } catch (IOException exc) {
                System.err.printf("ERROR > Datagram Socket sending error: %s\n", exc.getLocalizedMessage());
                System.err.printf("ERROR > Packet: \"%s\" discarded!", Arrays.toString(packet.getData()));
                break;
            } catch (SecurityException exc) {
                System.err.printf("ERROR > Security error: %s\n", exc.getLocalizedMessage());
                System.err.printf("ERROR > Packet: \"%s\" discarded!", Arrays.toString(packet.getData()));
                break;
            } catch (IllegalBlockingModeException exc) {
                System.err.printf("ERROR > Blocking mode does not match: %s\n", exc.getLocalizedMessage());
                System.err.printf("ERROR > Packet: \"%s\" discarded!", Arrays.toString(packet.getData()));
            } catch (IllegalArgumentException exc) {
                System.err.printf("ERROR > Invalid argument provided: %s\n", exc.getLocalizedMessage());
                System.err.printf("ERROR > Packet: \"%s\" discarded!", Arrays.toString(packet.getData()));
            }

            System.out.printf("INFO  > Address: \"%s\"\n",packet.getAddress());
            System.out.printf("INFO  > Port: \"%d\"\n",packet.getPort());
            System.out.printf("INFO  > Data: \"%s\"\n",Arrays.toString(packet.getData()));

            checksum.update(Arrays.copyOfRange(packet.getData(), 0, 248));
            if(checksum.getValue() == bytesToLong(Arrays.copyOfRange(packet.getData(), 248, 256))) {
                System.out.print("INFO  > Checksum correct!\n");
            } else {
                System.out.print("INFO  > Checksum invalid!\n");
            }
        }

        socket.close();
    }


    private static byte[] longToBytes(long x) {
        ByteBuffer buffer = ByteBuffer.allocate(Long.BYTES);
        buffer.putLong(x);
        return buffer.array();
    }

    private static long bytesToLong(byte[] bytes) {
        ByteBuffer buffer = ByteBuffer.allocate(Long.BYTES);
        buffer.put(bytes);
        buffer.flip();//need flip
        return buffer.getLong();
    }
}
